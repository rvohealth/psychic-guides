---
sidebar_position: 1
---

# psychic

Psychic exposes a few different configuration points within the `conf` directory, but most of the configuration is done in `conf/app.ts`. This file enables you to express the underlying configuration for your psychic application, including encryption keys, cookie configurations, and much more.

In addition, Psychic exposes access to the underlying express framework, enabling you to use any express-compatible plugin without any fuss.

```
├── app
│   ├── conf
│   │   ├── app.ts             // main psychic config
│   │   ├── dream.ts           // dream bindings
│   │   ├── global.ts          // loaded by app entry points
│   │   ├── inflections.ts     // loaded by app entry points
│   │   ├── loadEnv.ts         // loaded by app entry points
│   │   ├── repl.ts            // entry point for console
│   │   ├── routes.ts          // describes your application routes
│   │   ├── routeTypes.ts      // autogenerated by psychic
```

## conf/app.ts

examining the `conf/app.ts` file, we will see many configuration options that can be tapped into with ease:

```ts
export default (psy: Psyconf) => {
  psy.set('appName', 'howyadoin')
  psy.set('useWs', true)
  psy.set('useRedis', true)
  psy.set('apiOnly', false)
  psy.set('encryption', {
    cookies: {
      current: {
        algorithm: 'aes-256-gcm',
        key: process.env.APP_ENCRYPTION_KEY!,
      },
    },
  })
  psy.set('apiRoot', path.join(__dirname, '..', '..'))
  psy.set('clientRoot', path.join(__dirname, '..', '..', '..', 'client'))
  psy.set('inflections', inflections)
  psy.set('routes', routesCb)
  // ...etc
}
```

### json

Use the `Psychonf#set` method to apply json (body parser) options. Json options are driven through the [body-parser](https://www.npmjs.com/package/body-parser) package.

```ts
export default (psy: Psyconf) => {
  psy.set('json', {
    limit: '20kb',
  })
}
```

### cookie

Use the `Psychonf#set` method to apply cookie options. Cookie options are driven through the express-cookie package.

```ts
export default (psy: Psyconf) => {
  // set options for cookie usage
  psy.set('cookie', {
    maxAge: {
      days: 14,
      hours: 0,
      minutes: 0,
      seconds: 0,
      milliseconds: 0,
    },
  })
}
```

### encryption

Use the `Psychonf#set` method to apply encryption options.

```ts
export default (psy: Psyconf) => {
  psy.set('encryption', {
    cookies: {
      current: {
        algorithm: 'aes-256-gcm',
        key: process.env.APP_ENCRYPTION_KEY!,
      },
      // legacy is used when you are in the process of switching out your encryption keys
      legacy: {
        algorithm: 'aes-256-gcm',
        key: process.env.LEGACY_APP_ENCRYPTION_KEY!,
      },
    },
  })
}
```

### cors

Use the `Psychonf#set` method to apply cors options. Cors options are driven through the express-cors package.

```ts
export default (psy: Psyconf) => {
  // set options for cors
  psy.set('cors', {
    credentials: true,
    origin: [process.env.CLIENT_HOST || 'http://localhost:3000'],
  })
}
```

### redis

Use the `Psychonf#set` method to apply redis options. Redis options are driven by the [node-redis](https://github.com/redis/node-redis) package.

```ts
export default (psy: Psyconf) => {
  // redis background job credentials
  psy.set('redis:background', {
    username: process.env.BACKGROUND_JOBS_REDIS_USER,
    password: process.env.BACKGROUND_JOBS_REDIS_PASSWORD,
    host: process.env.BACKGROUND_JOBS_REDIS_HOST,
    port: process.env.BACKGROUND_JOBS_REDIS_PORT,
    secure: process.env.BACKGROUND_JOBS_REDIS_USE_SSL === '1',
  })

  // redis websocket credentials
  psy.set('redis:ws', {
    username: process.env.WS_REDIS_USER,
    password: process.env.WS_REDIS_PASSWORD,
    host: process.env.WS_REDIS_HOST,
    port: process.env.WS_REDIS_PORT,
    secure: process.env.WS_REDIS_USE_SSL === '1',
  })
}
```

### background job options

Use the `Psychonf#set` method to apply background queue options. Since background jobs are driven by BullMQ, the options here are passed to the job instance of the BullMQ package.

```ts
export default (psy: Psyconf) => {
  // configuration options for bullmq queue (used for running background jobs in redis)
  psy.set('background:queue', {
    defaultJobOptions: {
      removeOnComplete: 1000,
      removeOnFail: 20000,
      // 524,288,000 ms (~6.1 days) using algorithm:
      // "2 ^ (attempts - 1) * delay"
      attempts: 20,
      backoff: {
        type: 'exponential',
        delay: 1000,
      },
    },
  })

  // configuration options for bullmq worker (used for running background jobs in redis)
  psy.set('background:worker', {})
}
```

### hooks

Hooks are called during specific lifecycle events in the server initialization process.

```ts
export default (psy: PsychicConfig) => {
  // run once an express app is initialized by the psychic server
  psy.on('express:init', (app) => {
    if (!testEnv() || process.env.REQUEST_LOGGING === '1') {
      const SENSITIVE_FIELDS = [
        'password',
        'token',
        'authentication',
        'authorization',
        'secret',
      ]

      app.use(
        expressWinston.logger({
          transports: [new winston.transports.Console()],
          format: winston.format.combine(
            winston.format.colorize(),
            winston.format.json(),
          ),
          meta: true, // optional: control whether you want to log the meta data about the request (default to true)
          msg: 'HTTP {{req.method}} {{req.url}}', // optional: customize the default logging message. E.g. "{{res.statusCode}} {{req.method}} {{res.responseTime}}ms {{req.url}}"
          expressFormat: true, // Use the default Express/morgan request formatting. Enabling this will override any msg if true. Will only output colors with colorize set to true
          colorize: false, // Color the text and status code, using the Express/morgan color palette (text: gray, status: default green, 3XX cyan, 4XX yellow, 5XX red).
          headerBlacklist: [
            'authorization',
            'content-length',
            'connection',
            'cookie',
            'sec-ch-ua',
            'sec-ch-ua-mobile',
            'sec-ch-ua-platform',
            'sec-fetch-dest',
            'sec-fetch-mode',
            'sec-fetch-site',
            'user-agent',
          ],
          ignoredRoutes: ['/health_check'],
          bodyBlacklist: SENSITIVE_FIELDS,
        }),
      )
    }
  })

  // run a callback on server boot (but before routes are processed)
  psy.on('boot', () => {})

  // run a callback after routes are done processing
  psy.on('after:routes', () => {})

  // run a callback after the config is loaded
  psy.on('load', async () => {
    // uncomment to initialize background jobs
    // (this should only be done if useRedis is true)
    await background.connect()
  })

  // run a callback after the config is loaded, but only if NODE_ENV=development
  psy.on('load:dev', () => {})

  // run a callback after the config is loaded, but only if NODE_ENV=test
  psy.on('load:test', () => {})

  // run a callback after the config is loaded, but only if NODE_ENV=production
  psy.on('load:prod', () => {})

  // this function will be run any time a server error is encountered
  // that psychic isn't sure how to respond to (i.e. 500 internal server errors)
  psy.on('server:error', (err, _, res) => {
    if (!res.headersSent) res.sendStatus(500)
    else if (developmentOrTestEnv()) throw err
  })

  // run a callback after the websocket server is initially started
  psy.on('ws:start', () => {})

  // run a callback after connection to the websocket service
  psy.on('ws:connect', () => {})
}
```
