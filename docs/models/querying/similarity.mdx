# similarity

Similarity operations enable fuzzy text searching using PostgreSQL's `pg_trgm` extension. Dream provides three similarity operators with configurable scoring thresholds for different matching strategies.

## Setup

Before using similarity operations, you need to set up the `pg_trgm` extension and optionally create GIN indexes for better performance:

```ts
// In a migration file
import { DreamMigrationHelpers } from '@rvoh/dream'
import { Kysely } from 'kysely'

export async function up(db: Kysely<any>): Promise<void> {
  // Create the pg_trgm extension (only needed once per database)
  await DreamMigrationHelpers.createExtension(db, 'pg_trgm')

  // Create GIN index for better performance (optional but recommended)
  await DreamMigrationHelpers.createGinIndex(db, 'users_name_gin_index', {
    table: 'users',
    column: 'name',
  })
}

export async function down(db: Kysely<any>): Promise<void> {
  await db.schema.dropIndex('users_name_gin_index').execute()
}
```

## Similarity Operators

### ops.similarity()

The `similarity()` operator uses trigram similarity with a default score threshold of **0.3**. It's the most flexible similarity operator and works well for general fuzzy matching.

```ts
import { ops } from '@rvoh/dream'

// Basic similarity search (uses default score of 0.3)
const users = await User.where({
  name: ops.similarity('steeven hawkins'),
}).all()

// Custom similarity score (0.0 = very loose, 1.0 = exact match)
const users = await User.where({
  name: ops.similarity('steeven hawkins', { score: 0.2 }),
}).all()
```

### ops.wordSimilarity()

The `wordSimilarity()` operator uses word-based similarity with a default score threshold of **0.5**. It's better at matching individual words within longer text.

```ts
// Basic word similarity search (uses default score of 0.5)
const users = await User.where({
  name: ops.wordSimilarity('steeven hawkins'),
}).all()

// Custom word similarity score
const users = await User.where({
  name: ops.wordSimilarity('steeven hawkins', { score: 0.3 }),
}).all()
```

### ops.strictWordSimilarity()

The `strictWordSimilarity()` operator uses strict word-based similarity with a default score threshold of **0.6**. It provides the most precise matching.

```ts
// Basic strict word similarity search (uses default score of 0.6)
const users = await User.where({
  name: ops.strictWordSimilarity('steeven hawkins'),
}).all()

// Custom strict similarity score
const users = await User.where({
  name: ops.strictWordSimilarity('steeven hawkins', { score: 0.4 }),
}).all()
```

## Score Thresholds

All similarity operators accept an optional `score` parameter that controls the matching threshold:

- **0.0** - Very loose matching (matches almost anything)
- **0.3** - Default for `similarity()` - good balance of recall and precision
- **0.5** - Default for `wordSimilarity()` - moderate precision
- **0.6** - Default for `strictWordSimilarity()` - high precision
- **1.0** - Exact match only

```ts
// Low threshold - more results, less precise
const looseResults = await User.where({
  name: ops.similarity('john', { score: 0.1 }),
}).all()

// High threshold - fewer results, more precise
const preciseResults = await User.where({
  name: ops.similarity('john', { score: 0.8 }),
}).all()
```

### GIN Indexes

For optimal performance on large datasets, create GIN indexes on columns you'll search frequently:

```ts
// In your migration
await DreamMigrationHelpers.createGinIndex(db, 'posts_title_gin_index', {
  table: 'posts',
  column: 'title',
})

await DreamMigrationHelpers.createGinIndex(db, 'posts_content_gin_index', {
  table: 'posts',
  column: 'content',
})
```
