# similarity

Similarity operations enable fuzzy text searching using PostgreSQL's `pg_trgm` extension. Dream provides three similarity operators with configurable scoring thresholds for different matching strategies.

## Setup

Before using similarity operations, you need to set up the `pg_trgm` extension and optionally create GIN indexes for better performance:

```ts
// In a migration file
import { DreamMigrationHelpers } from '@rvoh/dream'
import { Kysely } from 'kysely'

export async function up(db: Kysely<any>): Promise<void> {
  // Create the pg_trgm extension (only needed once per database)
  await DreamMigrationHelpers.createExtension(db, 'pg_trgm')

  // Create GIN index for better performance (optional but recommended)
  await DreamMigrationHelpers.createGinIndex(db, 'users_name_gin_index', {
    table: 'users',
    column: 'name',
  })
}

export async function down(db: Kysely<any>): Promise<void> {
  await db.schema.dropIndex('users_name_gin_index').execute()
}
```

## Similarity Operators

### ops.similarity()

The `similarity()` operator uses trigram similarity with a default score threshold of **0.3**. It's the most flexible similarity operator and works well for general fuzzy matching.

```ts
import { ops } from '@rvoh/dream'

// Basic similarity search (uses default score of 0.3)
const users = await User.where({
  name: ops.similarity('steeven hawkins'),
}).all()

// Custom similarity score (0.0 = very loose, 1.0 = exact match)
const users = await User.where({
  name: ops.similarity('steeven hawkins', { score: 0.2 }),
}).all()
```

**Use cases:**

- General fuzzy text searching
- Handling typos in user input
- Finding similar names or terms

### ops.wordSimilarity()

The `wordSimilarity()` operator uses word-based similarity with a default score threshold of **0.5**. It's better at matching individual words within longer text.

```ts
// Basic word similarity search (uses default score of 0.5)
const users = await User.where({
  name: ops.wordSimilarity('steeven hawkins'),
}).all()

// Custom word similarity score
const users = await User.where({
  name: ops.wordSimilarity('steeven hawkins', { score: 0.3 }),
}).all()
```

**Use cases:**

- Searching within longer text fields
- Matching partial words or phrases
- Finding relevant content when searching for specific terms

### ops.strictWordSimilarity()

The `strictWordSimilarity()` operator uses strict word-based similarity with a default score threshold of **0.6**. It provides the most precise matching.

```ts
// Basic strict word similarity search (uses default score of 0.6)
const users = await User.where({
  name: ops.strictWordSimilarity('steeven hawkins'),
}).all()

// Custom strict similarity score
const users = await User.where({
  name: ops.strictWordSimilarity('steeven hawkins', { score: 0.4 }),
}).all()
```

**Use cases:**

- High-precision text matching
- When you need fewer but more accurate results
- Reducing false positives in search results

## Score Thresholds

All similarity operators accept an optional `score` parameter that controls the matching threshold:

- **0.0** - Very loose matching (matches almost anything)
- **0.3** - Default for `similarity()` - good balance of recall and precision
- **0.5** - Default for `wordSimilarity()` - moderate precision
- **0.6** - Default for `strictWordSimilarity()` - high precision
- **1.0** - Exact match only

```ts
// Low threshold - more results, less precise
const looseResults = await User.where({
  name: ops.similarity('john', { score: 0.1 }),
}).all()

// High threshold - fewer results, more precise
const preciseResults = await User.where({
  name: ops.similarity('john', { score: 0.8 }),
}).all()
```

## Performance Considerations

### GIN Indexes

For optimal performance on large datasets, create GIN indexes on columns you'll search frequently:

```ts
// In your migration
await DreamMigrationHelpers.createGinIndex(db, 'posts_title_gin_index', {
  table: 'posts',
  column: 'title',
})

await DreamMigrationHelpers.createGinIndex(db, 'posts_content_gin_index', {
  table: 'posts',
  column: 'content',
})
```

### Index Usage

GIN indexes are automatically used by PostgreSQL when:

- The column has a GIN index with `gin_trgm_ops` operator class
- You're using similarity operators on that column
- The query planner determines the index will improve performance

### Multiple Column Searches

When searching across multiple columns, consider creating separate indexes:

```ts
// Search across multiple indexed columns
const results = await Post.where(query =>
  query.where({ title: ops.similarity('search term') }).orWhere({ content: ops.similarity('search term') })
).all()
```

## Choosing the Right Operator

| Operator                 | Best For                             | Default Score | Precision |
| ------------------------ | ------------------------------------ | ------------- | --------- |
| `similarity()`           | General fuzzy search, typo tolerance | 0.3           | Balanced  |
| `wordSimilarity()`       | Partial word matching, longer text   | 0.5           | Moderate  |
| `strictWordSimilarity()` | High-precision matching              | 0.6           | High      |

## Examples

### E-commerce Product Search

```ts
// Flexible product search with typo tolerance
const products = await Product.where({
  name: ops.similarity(searchTerm, { score: 0.25 }),
})
  .limit(20)
  .all()
```

### User Directory Search

```ts
// Precise user name matching
const employees = await User.where({
  full_name: ops.strictWordSimilarity(query, { score: 0.7 }),
})
  .order('full_name')
  .all()
```

### Content Search

```ts
// Search blog posts by title and content
const posts = await Post.where(query =>
  query
    .where({ title: ops.wordSimilarity(searchTerm) })
    .orWhere({ content: ops.similarity(searchTerm, { score: 0.2 }) })
)
  .preload('author')
  .all()
```
